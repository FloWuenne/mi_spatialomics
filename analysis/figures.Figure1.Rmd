---
title: "molkart.Figure1"
author: "FloWuenne"
date: "2023-08-11"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Introduction

```{r}
library(tidyverse)
library(cowplot)
library(Seurat)
library(SCpubr)
library(pals)
library(patchwork)
library(ggbeeswarm)
library(viridis)

source("./code/functions.R")
```

```{r}
## If the object has already been computed
seurat_object <-  readRDS(file = "./output/molkart/molkart.harmony_seurat_object.rds")
```

```{r}
## How many cells did we recover per sample?
cells_per_sample <- seurat_object@meta.data %>%
  group_by(sample_ID) %>%
  tally() %>%
  ungroup()

mean(cells_per_sample$n)
```

# Umap plot

```{r}
seurat_object@meta.data$anno_cell_type_lvl2 <- gsub("_"," ",seurat_object@meta.data$anno_cell_type_lvl2)

pal.bands(alphabet, alphabet2, cols25, glasbey, kelly, polychrome, 
  stepped, tol, watlington, tableau20,
  show.names=FALSE)

cell_types <- unique(seurat_object@meta.data$anno_cell_type_lvl2)
colors <- kelly(n=length(cell_types))
## Replace white ish color as we can't see it well in plots
named_colors <- colors
names(named_colors) <- cell_types
named_colors[["Myeloid cells 2"]] <- kelly(n = 20)[[16]]
#named_colors[["Endocardial cells"]] <- kelly(n = 20)[[17]]
```

## Figure 1C : UMAP plot of cell types

```{r}
library(scCustomize)
## Set color palette
Idents(object = seurat_object) <- "anno_cell_type_lvl2"

umap_plot <- SCpubr::do_DimPlot(sample = seurat_object,
                                label = FALSE, label.box = TRUE,
                                group.by = "anno_cell_type_lvl2",
                                repel = TRUE, legend.position = "right", 
                                colors.use = named_colors, 
                                plot_cell_borders = TRUE,
                                plot_density_contour = FALSE, plot.axes = FALSE, raster.dpi = 300, 
                                shuffle = TRUE,
                                pt.size = 1, order = c("Cardiomyocytes Nppa+","Myeloid cells 1","Cardiomyocytes","Myeloid cells 2","Endocardial cells","Endothelial cells","Cardiac fibroblasts"),
                                legend.icon.size = 5, legend.byrow = TRUE) +
  theme(legend.text = element_text(size = 18))

umap_plot

save_plot(umap_plot,
          file = "./plots/Figure1.umap_plot.pdf",
          base_height = 6)


save_plot(umap_plot,
          file = "./plots/Figure1.umap_plot.png",
          base_height = 6)
```


# Figure 1D: Marker Dotplot

```{r}
harmony_object <- PrepSCTFindMarkers(seurat_object, assay = "SCT", verbose = TRUE)
harmony_markers <- FindAllMarkers(seurat_object, logfc.threshold = 0.5, only.pos = TRUE)
```


```{r}
## For the Dotplot, we want the same order as for the Umap plot, so we have to reverse it
seurat_object$anno_cell_type_lvl2 <- factor(seurat_object$anno_cell_type_lvl2,
                                            levels = rev(sort(unique(seurat_object$anno_cell_type_lvl2))))

# genes <- c("Myh11","Colec11","Csf3r","Ccl2","C1qa","Cdh5","Npr3","Postn",
#            "Cd74","Nppb","Nppa","Pln","Col1a1")
genes <- c("Pdgfra","Pln","Nppa","Nppb","Fn1","Npr3","Kdr","Sell",
           "C1qa","H2-Eb1","Csf3r","Ccl2","Colec11","Myh11")


dotplot <- DotPlot(seurat_object, group.by = "anno_cell_type_lvl2", features = genes) +
  geom_point(aes(size=pct.exp), shape = 21, colour="black", stroke=0.5) +
  scale_colour_viridis(option="viridis", direction = 1) +
  theme(axis.title =  element_blank(),
        axis.text.x = element_text(size = 18, angle = 45, hjust=1),
        axis.text.y = element_text(size = 18),
        legend.position = "right", legend.text = element_text(size = 18))
dotplot

save_plot(dotplot,
          file = "./plots/Figure1.dotplot.pdf",
          base_height = 6)
```

## Figure 1E: Cell type changes over time

```{r}
# ct_time_barplot_v2 <- ggplot(cell_type_proportions_per_sample,aes(x = timepoint,y = ct_perc_time, fill = anno_cell_type_lvl2)) +
#     stat_summary(
#       fun = mean,
#       geom = "bar",
#       width = 1,
#       color = "black") +
#   geom_beeswarm(size = 2.5, pch = 21, color = "black", fill= "white") +
#   facet_grid(. ~ anno_cell_type_lvl2) +
#   theme_bw() +
#   theme(axis.title = element_text(face="bold")) +
#   theme(axis.text.x = element_text(size = 14,angle = 45, vjust = 0.5, hjust=1),
#         strip.text.x = element_text(size = 14, colour = "black", angle = 90, face = "bold"),
#         strip.background = element_blank(),
#         legend.position = "none") + 
#   labs(x = "",
#        y = "% total cells") +
#   scale_fill_manual(values = named_colors)
# 
# ct_time_barplot_v2
# save_plot(ct_time_barplot_v2,filename = here("./plots/mol_cart.Figure_2.ct_percentage.pdf"),
#           base_height = 6,
#           base_asp = 2)
```

```{r}
## Reverese order again for the other plots
seurat_object$anno_cell_type_lvl2 <- factor(seurat_object$anno_cell_type_lvl2,
                                            levels = rev(sort(unique(seurat_object$anno_cell_type_lvl2))))

metadata <- seurat_object@meta.data

cell_type_proportions_per_sample <- metadata %>%
  group_by(anno_cell_type_lvl2,timepoint,sample_ID) %>%
  tally() %>%
  ungroup() %>%
  group_by(timepoint) %>%
  mutate("ct_perc_time" = n / sum(n)) %>%
  ungroup()

## Mean and points version
cell_type_proportions_per_sample$anno_cell_type_lvl2 <- gsub("_"," ",cell_type_proportions_per_sample$anno_cell_type_lvl2)

## Set order of cell types in plot from most abundant to least abundant
total_cells <- cell_type_proportions_per_sample %>%
  group_by(anno_cell_type_lvl2) %>%
  summarise("total_cells" = sum(n)) %>%
  arrange(desc(total_cells))

cell_type_proportions_per_sample$anno_cell_type_lvl2 <- factor(cell_type_proportions_per_sample$anno_cell_type_lvl2,
       levels = total_cells$anno_cell_type_lvl2)

cell_type_proportions_per_time <- cell_type_proportions_per_sample %>%
  group_by(anno_cell_type_lvl2,timepoint) %>%
  summarise("mean_perc" = mean(ct_perc_time) * 100)

ct_time_barplot <- ggplot(cell_type_proportions_per_time,aes(timepoint,mean_perc,fill = anno_cell_type_lvl2)) +
  geom_bar(stat = "identity", position = "dodge",color = "black") +
  scale_fill_manual(values = named_colors) +
  geom_text(aes(label=round(mean_perc,0)),
            position=position_dodge(width=0.9),
            vjust= -1, hjust = 0.4
            , size=3,  angle = 0) +
  scale_y_continuous(limits = c(0,30)) +
  labs(x = " Timepoint",
       y = "% total cells") +
  theme_minimal() +
  theme(legend.text=element_text(size=18),
        legend.title = element_blank(),
        legend.position = "none",
        axis.title = element_text(size=18),
        axis.text  = element_text(size=18)) 

ct_time_barplot

save_plot(ct_time_barplot,filename = here("./plots/molkart.Figure_1.ct_percentage.pdf"),
          base_height = 6)
```

## Figure 1F : Overview of spatial distribution of cell types within 1 sample

```{r}
sample_highlight <- "sample_2d_r1_s1"

meta_sample <- subset(seurat_object@meta.data,sample_ID == sample_highlight)

full_overview <-  ggplot(meta_sample,aes(X_centroid,Y_centroid)) +
    geom_point(aes(color = anno_cell_type_lvl2),size = 0.3) +
    theme_classic() +
    labs(x = "Spatial 1",
         y = "Spatial 2") +
    theme(axis.ticks = element_blank(),
          axis.text = element_blank(),
          axis.line = element_blank(),
          legend.position = "none") +
    scale_color_manual(values = named_colors)

cell_type_views <- ggplot(meta_sample,aes(X_centroid,Y_centroid)) +
  geom_point(aes(color = anno_cell_type_lvl2),size = 0.3) +
  scale_color_manual(values = named_colors) +
  facet_wrap(~ anno_cell_type_lvl2) +
  theme_void() +
  theme(legend.position = "none",
        strip.text = element_text(size = 9, color = "black"),
        # strip.background = element_rect(fill = "lightgrey",
        #                                 colour = "black",
        #                                 linetype = 1)
  )

full_plot <- full_overview | cell_type_views

full_plot
save_plot(full_plot,filename = here("./plots/molkart.Figure_1.spatial_distribution.pdf"),
          base_height = 7)
```


## Additional plots for presentations

### Spatial plot with all samples and cell types

```{r}
meta <- seurat_object@meta.data

expression_plot_list <- list()
samples <- c("sample_control_r1_s1","sample_4h_r1_s1",
             "sample_2d_r1_s1","sample_4d_r1_s1",
             "sample_control_r2_s1","sample_4h_r2_s2",
             "sample_2d_r2_s1","sample_4d_r2_s1")

for(this_sample in samples){
  pt_size <- 0.3
  cluster_of_int <- c(16,19)
  sample_object <- subset(meta,sample_ID == this_sample)
  
  highlight_plot <- ggplot(sample_object,aes(X_centroid,Y_centroid)) +
    geom_point(aes(color = anno_cell_type_lvl2),size = pt_size) +
    theme_void() +
    theme(axis.ticks = element_blank(),
            axis.text = element_blank(),
            legend.position = "none") +
    scale_color_manual(values =named_colors)
    
    expression_plot_list[[this_sample]] <- highlight_plot
  
}
```

```{r}
wrap_plots(expression_plot_list, nrow = 2, ncol = 4)
```

### Quantification of abundance changes for select cell types

```{r}
metadata <- seurat_object@meta.data

cell_type_proportions_per_sample <- metadata %>%
  group_by(anno_cell_type_lvl2,timepoint,sample_ID) %>%
  tally() %>%
  ungroup() %>%
  group_by(timepoint) %>%
  mutate("ct_perc_time" = n / sum(n)) %>%
  ungroup()

## Mean and points version
cell_type_proportions_per_sample$anno_cell_type_lvl2 <- gsub("_"," ",cell_type_proportions_per_sample$anno_cell_type_lvl2)

## Set order of cell types in plot from most abundant to least abundant
total_cells <- cell_type_proportions_per_sample %>%
  group_by(anno_cell_type_lvl2) %>%
  summarise("total_cells" = sum(n)) %>%
  arrange(desc(total_cells))

cell_type_proportions_per_sample$anno_cell_type_lvl2 <- factor(cell_type_proportions_per_sample$anno_cell_type_lvl2,
       levels = total_cells$anno_cell_type_lvl2)

## Set color palette for cell-types in molecular cartography data
cell_types <- unique(unique(cell_type_proportions_per_sample$anno_cell_type_lvl2))
colors <- cols25(n=length(cell_types))
named_colors <- colors
names(named_colors) <- cell_types

cell_types_oi <- c("Cardiomyocytes","Cardiac fibroblasts","Cardiomyocytes Nppa+","Myeloid cells")
cell_type_proportions_per_sample <- subset(cell_type_proportions_per_sample,
                                           anno_cell_type_lvl2 %in% cell_types_oi)

ct_time_barplot_v2 <- ggplot(cell_type_proportions_per_sample,aes(x = timepoint,y = ct_perc_time, fill = anno_cell_type_lvl2)) +
    stat_summary(
      fun.y = mean,
      geom = "bar",
      width = 1,
      color = "black") +
  geom_beeswarm(size = 2.5, pch = 21, color = "black", fill= "white") +
  facet_grid(. ~ anno_cell_type_lvl2) +
  theme_bw() +
  theme(axis.title = element_text(face="bold")) +
  theme(axis.text.x = element_text(size = 14,angle = 45, vjust = 0.5, hjust=1),
        strip.text.x = element_text(size = 14, colour = "black", angle = 90, face = "bold"),
        strip.background = element_blank(),
        legend.position = "none") + 
  labs(x = "",
       y = "% total cells") +
  scale_fill_manual(values = named_colors)

ct_time_barplot_v2
```


### Spatial plot showing abundance change over time

```{r}
samples <- c("sample_control_r1_s1","sample_4h_r1_s1",
             "sample_2d_r2_s1","sample_4d_r2_s1")

expression_plot_list <- list()
time_plot_list <- list()

colors_used <- named_colors[cell_types_oi]

for(cluster_of_int in cell_types_oi){
  print(cluster_of_int)
  color_use <- colors_used[[cluster_of_int]]
  for(this_sample in samples){
    pt_size <- 0.1
    sample_object <- subset(seurat_object,sample_ID == this_sample)
    meta <- sample_object@meta.data
    
    highlight_plot <- ggplot(meta,aes(Y_centroid,X_centroid)) +
      geom_point(data = subset(meta,!seurat_clusters %in% cluster_of_int),color = "darkgrey", size = pt_size) +
      geom_point(data = subset(meta,gsub("_"," ",anno_cell_type_lvl2) == cluster_of_int),color = color_use, size = pt_size * 2) +
      theme_classic() +
      labs(x = "Spatial 1",
           y = "Spatial 2") +
      theme(axis.ticks = element_blank(),
            axis.text = element_blank(),
            legend.position = "right")
    
    expression_plot_list[[this_sample]] <- highlight_plot
  }
  time_plot <- wrap_plots(expression_plot_list, nrow = 1, ncol = 4)  + plot_layout(guides = 'collect') + plot_annotation(cluster_of_int,theme=theme(plot.title=element_text(hjust=0.5)))
  time_plot_list[[cluster_of_int]] <- time_plot
}

final_plot <- wrap_plots(time_plot_list, nrow = length(cell_types_oi), ncol = 1)  + plot_layout(guides = 'collect')
final_plot
```

### Plot target cell types from one time point next to each other

```{r}
samples <- c("sample_control_r1_s1","sample_2d_r1_s1")

expression_plot_list <- list()
time_plot_list <- list()

cell_types_oi <- c("Endocardial cells","Cardiomyocytes Nppa+","Macrophages")
colors_used <- named_colors[cell_types_oi]

  
for(cluster_of_int in cell_types_oi){
  print(cluster_of_int)
  color_use <- colors_used[[cluster_of_int]]
  if(cluster_of_int == "Endocardial cell"){color_use <- "red"}
  pt_size <- 0.2
    sample_object <- subset(seurat_object,sample_ID == "sample_2d_r1_s1")
    meta <- sample_object@meta.data
    
    highlight_plot <- ggplot(meta,aes(Y_centroid,X_centroid)) +
      geom_point(data = subset(meta,!seurat_clusters %in% cluster_of_int),color = "darkgrey", size = pt_size) +
      geom_point(data = subset(meta,gsub("_"," ",anno_cell_type_lvl2) == cluster_of_int),color = color_use, size = pt_size * 4) +
      theme_classic() +
      labs(x = "Spatial 1",
           y = "Spatial 2") +
      theme(axis.ticks = element_blank(),
            axis.text = element_blank(),
            legend.position = "right")
    
    expression_plot_list[[cluster_of_int]] <- highlight_plot
}

cell_type_plot <- wrap_plots(expression_plot_list, nrow = 1, ncol = 3)  + plot_layout(guides = 'collect')
cell_type_plot
```

